---
# configure deployment and continuous integration at travis-ci.com

arch: amd64
dist: bionic
language: cpp
os: linux

jobs:
  include:

    # MacOSX32 and MacOSX64 (job .1):
    - os: osx
      osx_image: xcode9.4.1
      script:
        - ./gradlew build --console=plain --no-daemon -Ptravis=osx

    # Linux32 and Linux64 non-multithreaded (job .2):
    - env:
        - FLAVOR=noMt
      addons:
        apt:
          packages:
            - g++-7-multilib
      script:
        - sudo ln -s /usr/include/x86_64-linux-gnu/asm /usr/include/asm
        - sudo ln -s /usr/include/x86_64-linux-gnu/bits /usr/include/bits
        - g++ --version
        - ./gradlew build --console=plain --no-daemon -Ptravis=amd64

    # Linux64 multithreaded (job .3):
    - env:
        - FLAVOR=Mt64
      script:
        - g++ --version
        - ./gradlew build --console=plain --no-daemon -Ptravis=amd64mt

    # Linux_ARM32 software floating-point, double-precision (job .4):
    - arch: arm64
      compiler: arm-linux-gnueabi-g++-7
      addons:
        apt:
          packages:
            - g++-7-arm-linux-gnueabi
      env:
        - FLAVOR=Dp32
      script:
        - arm-linux-gnueabi-g++-7 -E -v
        - travis_wait 20 ./gradlew assemble --console=plain --no-daemon -Pflavor=Dp -Ptravis=arm32

    # Linux_ARM32 software floating-point, single-precision (job .5):
    - arch: arm64
      compiler: arm-linux-gnueabi-g++-7
      addons:
        apt:
          packages:
            - g++-7-arm-linux-gnueabi
      env:
        - FLAVOR=Sp32
      script:
        - arm-linux-gnueabi-g++-7 -E -v
        - travis_wait 20 ./gradlew assemble --console=plain --no-daemon -Pflavor=Sp -Ptravis=arm32

    # Linux_ARM32hf double-precision (job .6):
    - arch: arm64
      compiler: arm-linux-gnueabihf-g++-6
      addons:
        apt:
          packages:
            - g++-6-arm-linux-gnueabihf
      env:
        - FLAVOR=Dp32
      script:
        - arm-linux-gnueabihf-g++-6 -E -v
        - travis_wait 20 ./gradlew assemble --console=plain --no-daemon -Pflavor=Dp -Ptravis=arm32hf

    # Linux_ARM32hf single-precision (job .7):
    - arch: arm64
      compiler: arm-linux-gnueabihf-g++-6
      addons:
        apt:
          packages:
            - g++-6-arm-linux-gnueabihf
      env:
        - FLAVOR=Sp32
      script:
        - arm-linux-gnueabihf-g++-6 -E -v
        - travis_wait 20 ./gradlew assemble --console=plain --no-daemon -Pflavor=Sp -Ptravis=arm32hf

    # Linux_ARM64 double-precision (job .8):
    - arch: arm64
      compiler: gcc-6
      addons:
        apt:
          packages:
            - g++-6
      env:
        - FLAVOR=Dp64
      script:
        - aarch64-linux-gnu-g++-6 -E -v
        - travis_wait 20 ./gradlew build --console=plain --no-daemon -Pflavor=Dp -Ptravis=arm64

    # Linux_ARM64 single-precision (job .9):
    - arch: arm64
      compiler: gcc-6
      addons:
        apt:
          packages:
            - g++-6
      env:
        - FLAVOR=Sp64
      script:
        - aarch64-linux-gnu-g++-6 -E -v
        - travis_wait 20 ./gradlew build --console=plain --no-daemon -Pflavor=Sp -Ptravis=arm64

    # Android_ARM7, Android_ARM8, Android_X86, and Android_X86_64 (job .10):
    - dist: trusty
      language: android
      android:
        components:
          - tools
      script:
        - echo y | sdkmanager "ndk;21.3.6528147" > /dev/null
        - echo y | sdkmanager "patcher;v4" > /dev/null
        - ./gradlew copyToDist --build-file=android.gradle --console=plain --no-daemon


addons:
  apt:
    update: true
after_failure:
  - cat build/reports/tests/test/classes/TestLibbulletjme.html
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: "D5WJLmRPeb3C/h7ybwlJF4xqr7BwaCTTS7Hw8NBvehkBmjq4wdiN3bVG5byI9k3qtxaqzK3Rh1Jd2EJZ55vvg+JBi+2c2sKVnE8FzHpSrHvkCc5X3r99CnP2e0hMcH29kgP6buSvrInguOAw/QPIWy1fminBrFN/ekDV85wM1tcgwLyoyFmn/e3jSfYvOnnAKP3MR6KnBaT8M6jgYIBrRNgYIMzNdJwyl/b+5Tb2HoJIl7lJSxytX+DPz5/lGDcH6WkrgPGcNEw5kSZmgExgTfNP8lU/TGULAfhGmqL6awsgY+EHoEJLzTwzIMz94EhUVhMb2CbUb/NPhJUQjGU5ohB8S0U9RX27+YVH6zH0Hl0yVEtHWoqsHtY1+Ax2K6ACz5Z31IfXTQF0mHFbQZoTTuPH95zG/SLOikD0MjXe+6CpAUFpZhtBK1GGdJTge37PodxZpfRn80lHRBQB4zWuLADxiefER5AOjvSYPZwGYC30tvs7IaYbW3z2L5Xh9XNGRsFZWwk6Zuj7Y3NCUfS2iE+thsNnSQqOjtBPtg6dYUUjo72X0+h2ch0tQ3NXVjhjqhpmiNvZCV10awYylluHS6LfsBBkW3+pfduVsEqCvLfF5AiCu/w7HLSXh1CvwB+xhkF6sPglquNUqEN7dOPSCVJTS69i+dChilaHM51GIZI="
  file:
    - dist/Android_ARM7DebugSp_libbulletjme.so
    - dist/Android_ARM7ReleaseSp_libbulletjme.so
    - dist/Android_ARM8DebugSp_libbulletjme.so
    - dist/Android_ARM8ReleaseSp_libbulletjme.so
    - dist/Android_X86DebugSp_libbulletjme.so
    - dist/Android_X86ReleaseSp_libbulletjme.so
    - dist/Android_X86_64DebugSp_libbulletjme.so
    - dist/Android_X86_64ReleaseSp_libbulletjme.so
    - dist/Linux32DebugDp_libbulletjme.so
    - dist/Linux32DebugSp_libbulletjme.so
    - dist/Linux32ReleaseDp_libbulletjme.so
    - dist/Linux32ReleaseSp_libbulletjme.so
    - dist/Linux64DebugDp_libbulletjme.so
    - dist/Linux64DebugDpMt_libbulletjme.so
    - dist/Linux64DebugSp_libbulletjme.so
    - dist/Linux64DebugSpMt_libbulletjme.so
    - dist/Linux64ReleaseDp_libbulletjme.so
    - dist/Linux64ReleaseDpMt_libbulletjme.so
    - dist/Linux64ReleaseSp_libbulletjme.so
    - dist/Linux64ReleaseSpMt_libbulletjme.so
    - dist/Linux_ARM32DebugDp_libbulletjme.so
    - dist/Linux_ARM32DebugSp_libbulletjme.so
    - dist/Linux_ARM32ReleaseDp_libbulletjme.so
    - dist/Linux_ARM32ReleaseSp_libbulletjme.so
    - dist/Linux_ARM32hfDebugDp_libbulletjme.so
    - dist/Linux_ARM32hfDebugSp_libbulletjme.so
    - dist/Linux_ARM32hfReleaseDp_libbulletjme.so
    - dist/Linux_ARM32hfReleaseSp_libbulletjme.so
    - dist/Linux_ARM64DebugDp_libbulletjme.so
    - dist/Linux_ARM64DebugSp_libbulletjme.so
    - dist/Linux_ARM64ReleaseDp_libbulletjme.so
    - dist/Linux_ARM64ReleaseSp_libbulletjme.so
    - dist/MacOSX32DebugDp_libbulletjme.dylib
    - dist/MacOSX32DebugSp_libbulletjme.dylib
    - dist/MacOSX32ReleaseDp_libbulletjme.dylib
    - dist/MacOSX32ReleaseSp_libbulletjme.dylib
    - dist/MacOSX64DebugDp_libbulletjme.dylib
    - dist/MacOSX64DebugSp_libbulletjme.dylib
    - dist/MacOSX64ReleaseDp_libbulletjme.dylib
    - dist/MacOSX64ReleaseSp_libbulletjme.dylib
  on:
    repo: stephengold/Libbulletjme
    tags: true   # deploy on tag push only
